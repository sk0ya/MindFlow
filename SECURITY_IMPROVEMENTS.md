# セキュリティ強化された認証システム

## 実装された改善点

### 1. 永続セッション管理
- **マジックリンクトークンの代替**: 一時的なマジックリンクトークンの代わりに、30日間有効な永続セッショントークンを使用
- **デバイス識別**: サーバーサイドとクライアントサイドの両方でデバイスフィンガープリンティングを実装
- **セッション制限**: デバイスごとに1つのアクティブセッションのみ許可

### 2. デバイス・ブラウザフィンガープリンティング
- **クライアントサイド**: 画面解像度、タイムゾーン、言語設定、プラットフォーム情報等を使用
- **サーバーサイド**: User-Agent、Accept-Language、IPアドレス、国情報等を使用
- **柔軟な検証**: IPアドレス変更は許可、国変更は高リスクとして扱う

### 3. レートリミッティング
- **ログイン試行**: 5回/5分
- **認証検証**: 10回/1分  
- **セッション作成**: 3回/5分
- Cloudflare KVを使用した分散レートリミット

### 4. 自動再認証システム
- **非アクティブ期間**: 1ヶ月間アクセスがない場合、自動的にセッションを無効化
- **継続的検証**: 1時間間隔でセッション有効性を検証
- **グレースフルハンドリング**: セッション期限切れ時の適切なエラーメッセージ

## セキュリティ機能詳細

### デバイス検証レベル
1. **完全一致** (リスク: 低): デバイスハッシュが完全に一致
2. **ブラウザ一致** (リスク: 低): 同じブラウザ、IPアドレスのみ変更
3. **部分一致** (リスク: 中): 一部の属性が変更
4. **国変更** (リスク: 高): 国が変更された場合はアクセス拒否

### データベーススキーマ
```sql
-- メインセッションテーブル
user_sessions (
  id, user_id, session_token, device_hash, device_info,
  expires_at, created_at, last_accessed_at, access_count, revoked_at
)

-- セッション統計（オプション）
session_stats (
  id, user_id, event_type, device_hash, timestamp, metadata
)
```

### API エンドポイント
- `POST /api/auth/login` - Magic link送信（レートリミット付き）
- `POST /api/auth/verify` - Magic link検証とセッション作成
- `GET /api/auth/validate` - セッション検証
- `POST /api/auth/logout` - セッション無効化

## セキュリティ考慮事項

### 実装済み対策
✅ CSRF保護（SameSite cookies使用想定）
✅ ブルートフォース攻撃防止（レートリミット）
✅ セッション固定攻撃防止（新セッション生成）
✅ デバイス乗っ取り検出（フィンガープリンティング）
✅ 不正アクセス監視（デバイス変更検出）

### 推奨追加対策
- HTTPS強制（本番環境）
- Content Security Policy (CSP) 設定
- セキュリティヘッダーの追加
- 監査ログの長期保存
- 異常アクセスパターンの機械学習検出

## 運用手順

### デプロイメント
1. データベースマイグレーションを実行
2. 環境変数を設定（API キー、CORS設定等）
3. フロントエンドとバックエンドを同時デプロイ

### 監視項目
- アクティブセッション数
- 認証失敗率
- デバイス変更検出率
- レートリミット発動回数

### インシデント対応
- 異常なセッション作成パターンの検出
- 大量の認証失敗の監視
- 地理的に不審なアクセスパターンの確認

## 技術仕様

### フロントエンド
- TypeScript
- デバイスフィンガープリンティング
- 自動セッション検証
- エラーハンドリング

### バックエンド
- Cloudflare Workers
- D1 Database
- KV Store (レートリミット)
- セキュア乱数生成

### 暗号化
- SHA-256ハッシュ
- セキュア乱数生成（crypto.getRandomValues）
- HMAC署名検証